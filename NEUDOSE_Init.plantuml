@startuml

' Define colors and styles
!define STATE_COLOR #lightblue
!define EVENT_COLOR #lightgreen
!define ACTION_COLOR #lightyellow

' Apply styles
skinparam state {
    BackgroundColor STATE_COLOR
    BorderColor black
    FontColor black
}

skinparam stateStyle {
    BackgroundColor STATE_COLOR
    BorderColor black
    FontColor black
}

skinparam event {
    BackgroundColor EVENT_COLOR
    BorderColor black
    FontColor black
}

skinparam action {
    BackgroundColor ACTION_COLOR
    BorderColor black
    FontColor black
}

title State Transition Diagram

left to right direction

[*] --> ST_INIT_ENABLE_BEACONING_OVERRIDE

ST_INIT_ENABLE_BEACONING_OVERRIDE --> ST_INIT_CXN_DISABLE_ANTENNAS : <<success>> EV_ENABLE_BEACONING_SUCCESS / fsm_antenna_request_disable
ST_INIT_ENABLE_BEACONING_OVERRIDE --> ST_INIT_POWER_DOWN_COMMS : <<failure>> EV_ENABLE_BEACONING_FAILURE / fsm_power_down_comms
ST_INIT_ENABLE_BEACONING_OVERRIDE --> ST_INIT_POWER_DOWN_COMMS : <<timeout>> EV_COMMS_TIMEOUT / fsm_power_down_comms
ST_INIT_ENABLE_BEACONING_OVERRIDE --> ST_INIT_ENABLE_BEACONING_VOLTAGE_CHECK : EV_SYS_START
ST_INIT_ENABLE_BEACONING_OVERRIDE --> ST_INIT_ENABLE_BEACONING_OVERRIDE : EV_ANY

ST_INIT_WAITING_FOR_GS_MESSAGE --> ST_INIT_POWER_DOWN_COMMS : <<critical>> EV_EPS_VOLTAGE_CRITICAL / fsm_power_down_comms
ST_INIT_WAITING_FOR_GS_MESSAGE --> ST_INIT_DISABLE_BEACONING : <<safe>> EV_EPS_VOLTAGE_SAFE / fsm_beaconing_disable
ST_INIT_WAITING_FOR_GS_MESSAGE --> ST_INIT_CXN_DISABLE_ANTENNAS : <<connected>> EV_GS_CONNECTED / fsm_antenna_request_disable
ST_INIT_WAITING_FOR_GS_MESSAGE --> ST_INIT_POWER_DOWN_COMMS : <<timeout>> EV_NO_MESSAGE_FROM_GS_GREATER_72HRS / fsm_power_down_comms
ST_INIT_WAITING_FOR_GS_MESSAGE --> ST_INIT_ENABLE_BEACONING_VOLTAGE_CHECK : EV_SYS_START
ST_INIT_WAITING_FOR_GS_MESSAGE --> ST_INIT_WAITING_FOR_GS_MESSAGE : EV_ANY

ST_INIT_CXN_DISABLE_ANTENNAS --> ST_INIT_CXN_POWER_DOWN_ANTENNAS : <<success>> EV_ANTENNA_DISABLE_SUCCESS / fsm_power_down_antennas
ST_INIT_CXN_DISABLE_ANTENNAS --> ST_CXN_CONNECTED_TO_GS : <<failure>> EV_ANTENNA_DISABLE_FAILURE / fsm_restart_gs_connection_timer
ST_INIT_CXN_DISABLE_ANTENNAS --> ST_INIT_CXN_DISABLE_ANTENNAS : EV_SYS_START
ST_INIT_CXN_DISABLE_ANTENNAS --> ST_INIT_CXN_DISABLE_ANTENNAS : EV_ANY

ST_INIT_CXN_POWER_DOWN_ANTENNAS --> ST_CXN_CONNECTED_TO_GS : <<success/failure>> EV_POWER_DOWN_ANTENNAS_SUCCESS / EV_POWER_DOWN_ANTENNAS_FAILURE / fsm_restart_gs_connection_timer
ST_INIT_CXN_POWER_DOWN_ANTENNAS --> ST_INIT_CXN_POWER_DOWN_ANTENNAS : EV_SYS_START
ST_INIT_CXN_POWER_DOWN_ANTENNAS --> ST_INIT_CXN_POWER_DOWN_ANTENNAS : EV_ANY

ST_INIT_DISABLE_BEACONING --> ST_INIT_ENABLE_BEACONING_VOLTAGE_CHECK : <<success>> EV_DISABLE_BEACONING_SUCCESS
ST_INIT_DISABLE_BEACONING --> ST_INIT_POWER_DOWN_COMMS : <<failure>> EV_DISABLE_BEACONING_FAILURE / fsm_power_down_comms
ST_INIT_DISABLE_BEACONING --> ST_INIT_POWER_DOWN_COMMS : <<timeout>> EV_COMMS_TIMEOUT / fsm_power_down_comms
ST_INIT_DISABLE_BEACONING --> ST_INIT_DISABLE_BEACONING : EV_SYS_START
ST_INIT_DISABLE_BEACONING --> ST_INIT_DISABLE_BEACONING : EV_ANY

ST_CXN_WAITING_FOR_GS_MESSAGE --> ST_CP_POWER_DOWN_COMMS : <<critical>> EV_EPS_VOLTAGE_CRITICAL / fsm_power_down_comms
ST_CXN_WAITING_FOR_GS_MESSAGE --> ST_SP_DISABLE_BEACONING_ATTEMPT1 : <<safe>> EV_EPS_VOLTAGE_SAFE / fsm_beaconing_disable
ST_CXN_WAITING_FOR_GS_MESSAGE --> ST_LP_WAITING_FOR_GS_MESSAGE : <<low>> EV_EPS_VOLTAGE_LOW
ST_CXN_WAITING_FOR_GS_MESSAGE --> ST_CXN_CONNECTED_TO_GS : <<connected>> EV_GS_CONNECTED / fsm_restart_gs_connection_timer
ST_CXN_WAITING_FOR_GS_MESSAGE --> ST_RECOVERY_POWER_DOWN_COMMS : <<timeout>> EV_NO_MESSAGE_FROM_GS_GREATER_72HRS / fsm_power_down_comms
ST_CXN_WAITING_FOR_GS_MESSAGE --> ST_RECOVERY : EV_SYS_START
ST_CXN_WAITING_FOR_GS_MESSAGE --> ST_CXN_WAITING_FOR_GS_MESSAGE : EV_ANY

ST_CXN_CONNECTED_TO_GS --> ST_CP_POWER_DOWN_COMMS : <<critical>> EV_EPS_VOLTAGE_CRITICAL / fsm_power_down_comms
ST_CXN_CONNECTED_TO_GS --> ST_SP_DISABLE_BEACONING_ATTEMPT1 : <<safe>> EV_EPS_VOLTAGE_SAFE / fsm_beaconing_disable
ST_CXN_CONNECTED_TO_GS --> ST_LP_CONNECTED_TO_GS : <<low>> EV_EPS_VOLTAGE_LOW
ST_CXN_CONNECTED_TO_GS --> ST_CXN_WAITING_FOR_GS_MESSAGE : <<disconnected>> EV_GS_DISCONNECTED
ST_CXN_CONNECTED_TO_GS --> ST_CXN_CONNECTED_TO_GS : <<connected>> EV_GS_CONNECTED / fsm_restart_gs_connection_timer
ST_CXN_CONNECTED_TO_GS --> ST_AM_POWER_UP_PAYLOAD : <<start>> EV_START_ACTIVE_MISSION / fsm_power_up_pld
ST_CXN_CONNECTED_TO_GS --> ST_RECOVERY : EV_SYS_START
ST_CXN_CONNECTED_TO_GS --> ST_CXN_CONNECTED_TO_GS : EV_ANY

ST_AM_POWER_UP_PAYLOAD --> ST_AM_PAYLOAD_PING_WAIT1 : <<success>> EV_POWER_UP_PAYLOAD_SUCCESS / fsm_wait_short
ST_AM_POWER_UP_PAYLOAD --> ST_CXN_CONNECTED_TO_GS : <<failure>> EV_POWER_UP_PAYLOAD_FAILURE
ST_AM_POWER_UP_PAYLOAD --> ST_RECOVERY : EV_SYS_START
ST_AM_POWER_UP_PAYLOAD --> ST_AM_POWER_UP_PAYLOAD : EV_ANY

ST_AM_PAYLOAD_PING_WAIT1 --> ST_AM_PAYLOAD_PING_ATTEMPT1 : <<finished>> EV_WAIT_SHORT_FINISHED / fsm_ping_pld
ST_AM_PAYLOAD_PING_WAIT1 --> ST_RECOVERY : EV_SYS_START
ST_AM_PAYLOAD_PING_WAIT1 --> ST_AM_PAYLOAD_PING_WAIT1 : EV_ANY

ST_AM_PAYLOAD_PING_ATTEMPT1 --> ST_AM_START_SCIENCE : <<success>> EV_PAYLOAD_PING_SUCCESS / fsm_start_data_pld
ST_AM_PAYLOAD_PING_ATTEMPT1 --> ST_AM_PAYLOAD_PING_WAIT2 : <<failure>> EV_PAYLOAD_PING_FAILURE / fsm_wait_medium
ST_AM_PAYLOAD_PING_ATTEMPT1 --> ST_RECOVERY : EV_SYS_START
ST_AM_PAYLOAD_PING_ATTEMPT1 --> ST_AM_PAYLOAD_PING_ATTEMPT1 : EV_ANY

ST_AM_PAYLOAD_PING_WAIT2 --> ST_AM_PAYLOAD_PING_ATTEMPT2 : <<finished>> EV_WAIT_MED_FINISHED / fsm_ping_pld
ST_AM_PAYLOAD_PING_WAIT2 --> ST_RECOVERY : EV_SYS_START
ST_AM_PAYLOAD_PING_WAIT2 --> ST_AM_PAYLOAD_PING_WAIT2 : EV_ANY

ST_AM_PAYLOAD_PING_ATTEMPT2 --> ST_AM_START_SCIENCE : <<success>> EV_PAYLOAD_PING_SUCCESS / fsm_start_data_pld
ST_AM_PAYLOAD_PING_ATTEMPT2 --> ST_AM_PAYLOAD_PING_WAIT3 : <<failure>> EV_PAYLOAD_PING_FAILURE / fsm_wait_long
ST_AM_PAYLOAD_PING_ATTEMPT2 --> ST_RECOVERY : EV_SYS_START
ST_AM_PAYLOAD_PING_ATTEMPT2 --> ST_AM_PAYLOAD_PING_ATTEMPT2 : EV_ANY

ST_AM_PAYLOAD_PING_WAIT3 --> ST_AM_PAYLOAD_PING_ATTEMPT3 : <<finished>> EV_WAIT_LONG_FINISHED / fsm_ping_pld
ST_AM_PAYLOAD_PING_WAIT3 --> ST_RECOVERY : EV_SYS_START
ST_AM_PAYLOAD_PING_WAIT3 --> ST_AM_PAYLOAD_PING_WAIT3 : EV_ANY

ST_AM_PAYLOAD_PING_ATTEMPT3 --> ST_AM_START_SCIENCE : <<success>> EV_PAYLOAD_PING_SUCCESS / fsm_start_data_pld
ST_AM_PAYLOAD_PING_ATTEMPT3 --> ST_AM_EXIT_CONNECTED : <<failure>> EV_PAYLOAD_PING_FAILURE / fsm_power_down_pld
ST_AM_PAYLOAD_PING_ATTEMPT3 --> ST_RECOVERY : EV_SYS_START
ST_AM_PAYLOAD_PING_ATTEMPT3 --> ST_AM_PAYLOAD_PING_ATTEMPT3 : EV_ANY

ST_AM_START_SCIENCE --> ST_AM_CONNECTED_TO_GS : <<success>> EV_START_SCIENCE_SUCCESS
ST_AM_START_SCIENCE --> ST_RECOVERY : EV_SYS_START
ST_AM_START_SCIENCE --> ST_AM_START_SCIENCE : EV_ANY

ST_AM_WAITING_FOR_GS_MESSAGE --> ST_AM_EXIT : <<timeout>> EV_SCIENCE_COLLECTION_TIMEOUT / fsm_power_down_pld
ST_AM_WAITING_FOR_GS_MESSAGE --> ST_CP_POWER_DOWN_PAYLOAD : <<critical>> EV_EPS_VOLTAGE_CRITICAL / fsm_power_down_pld
ST_AM_WAITING_FOR_GS_MESSAGE --> ST_SP_POWER_DOWN_PAYLOAD : <<safe>> EV_EPS_VOLTAGE_SAFE / fsm_power_down_pld
ST_AM_WAITING_FOR_GS_MESSAGE --> ST_LP_POWER_DOWN_PAYLOAD : <<low>> EV_EPS_VOLTAGE_LOW / fsm_power_down_pld
ST_AM_WAITING_FOR_GS_MESSAGE --> ST_AM_CONNECTED_TO_GS : <<connected>> EV_GS_CONNECTED / fsm_restart_gs_connection_timer
ST_AM_WAITING_FOR_GS_MESSAGE --> ST_RECOVERY_POWER_DOWN_COMMS : <<timeout>> EV_NO_MESSAGE_FROM_GS_GREATER_72HRS / fsm_power_down_comms
ST_AM_WAITING_FOR_GS_MESSAGE --> ST_RECOVERY : EV_SYS_START
ST_AM_WAITING_FOR_GS_MESSAGE --> ST_AM_WAITING_FOR_GS_MESSAGE : EV_ANY

ST_AM_CONNECTED_TO_GS --> ST_AM_EXIT_CONNECTED : <<timeout>> EV_SCIENCE_COLLECTION_TIMEOUT / fsm_power_down_pld
ST_AM_CONNECTED_TO_GS --> ST_CP_POWER_DOWN_PAYLOAD : <<critical>> EV_EPS_VOLTAGE_CRITICAL / fsm_power_down_pld
ST_AM_CONNECTED_TO_GS --> ST_SP_POWER_DOWN_PAYLOAD : <<safe>> EV_EPS_VOLTAGE_SAFE / fsm_power_down_pld
ST_AM_CONNECTED_TO_GS --> ST_LP_POWER_DOWN_PAYLOAD : <<low>> EV_EPS_VOLTAGE_LOW / fsm_power_down_pld
ST_AM_CONNECTED_TO_GS --> ST_AM_WAITING_FOR_GS_MESSAGE : <<disconnected>> EV_GS_DISCONNECTED
ST_AM_CONNECTED_TO_GS --> ST_AM_CONNECTED_TO_GS : <<connected>> EV_GS_CONNECTED / fsm_restart_gs_connection_timer
ST_AM_CONNECTED_TO_GS --> ST_AM_CONNECTED_TO_GS : EV_ANY
ST_AM_CONNECTED_TO_GS --> ST_AM_EXIT_CONNECTED : <<stop>> EV_STOP_ACTIVE_MISSION / fsm_power_down_pld
ST_AM_CONNECTED_TO_GS --> ST_RECOVERY : EV_SYS_START

ST_AM_EXIT_CONNECTED --> ST_AM_EXIT : <<success>> EV_POWER_DOWN_PAYLOAD_SUCCESS / fsm_power_down_pld
ST_AM_EXIT_CONNECTED --> ST_CP_POWER_DOWN_PAYLOAD : <<critical>> EV_EPS_VOLTAGE_CRITICAL / fsm_power_down_comms
ST_AM_EXIT_CONNECTED --> ST_SP_POWER_DOWN_PAYLOAD : <<safe>> EV_EPS_VOLTAGE_SAFE / fsm_power_down_pld
ST_AM_EXIT_CONNECTED --> ST_LP_POWER_DOWN_PAYLOAD : <<low>> EV_EPS_VOLTAGE_LOW / fsm_power_down_pld
ST_AM_EXIT_CONNECTED --> ST_AM_EXIT_CONNECTED : EV_SYS_START
ST_AM_EXIT_CONNECTED --> ST_AM_EXIT_CONNECTED : EV_ANY

ST_AM_EXIT --> ST_CP_POWER_DOWN_PAYLOAD : <<critical>> EV_EPS_VOLTAGE_CRITICAL / fsm_power_down_comms
ST_AM_EXIT --> ST_SP_POWER_DOWN_PAYLOAD : <<safe>> EV_EPS_VOLTAGE_SAFE / fsm_power_down_pld
ST_AM_EXIT --> ST_LP_POWER_DOWN_PAYLOAD : <<low>> EV_EPS_VOLTAGE_LOW / fsm_power_down_pld
ST_AM_EXIT --> ST_RECOVERY_POWER_DOWN_COMMS : <<timeout>> EV_COMMS_TIMEOUT / fsm_power_down_comms
ST_AM_EXIT --> ST_RECOVERY : EV_SYS_START
ST_AM_EXIT --> ST_AM_EXIT : EV_ANY

ST_CP_POWER_DOWN_COMMS --> ST_SP_POWER_DOWN_PAYLOAD : <<safe>> EV_EPS_VOLTAGE_SAFE / fsm_power_down_pld
ST_CP_POWER_DOWN_COMMS --> ST_RECOVERY : EV_SYS_START
ST_CP_POWER_DOWN_COMMS --> ST_CP_POWER_DOWN_COMMS : EV_ANY

ST_SP_DISABLE_BEACONING_ATTEMPT1 --> ST_LP_WAITING_FOR_GS_MESSAGE : <<low>> EV_EPS_VOLTAGE_LOW
ST_SP_DISABLE_BEACONING_ATTEMPT1 --> ST_CXN_WAITING_FOR_GS_MESSAGE : <<connected>> EV_EPS_VOLTAGE_NORMAL
ST_SP_DISABLE_BEACONING_ATTEMPT1 --> ST_RECOVERY_POWER_DOWN_COMMS : <<timeout>> EV_NO_MESSAGE_FROM_GS_GREATER_72HRS / fsm_power_down_comms
ST_SP_DISABLE_BEACONING_ATTEMPT1 --> ST_RECOVERY : EV_SYS_START
ST_SP_DISABLE_BEACONING_ATTEMPT1 --> ST_SP_DISABLE_BEACONING_ATTEMPT1 : EV_ANY

ST_LP_WAITING_FOR_GS_MESSAGE --> ST_CP_POWER_DOWN_COMMS : <<critical>> EV_EPS_VOLTAGE_CRITICAL / fsm_power_down_comms
ST_LP_WAITING_FOR_GS_MESSAGE --> ST_SP_DISABLE_BEACONING_ATTEMPT1 : <<safe>> EV_EPS_VOLTAGE_SAFE / fsm_beaconing_disable
ST_LP_WAITING_FOR_GS_MESSAGE --> ST_CXN_CONNECTED_TO_GS : <<normal>> EV_EPS_VOLTAGE_NORMAL
ST_LP_WAITING_FOR_GS_MESSAGE --> ST_RECOVERY_POWER_DOWN_COMMS : <<timeout>> EV_NO_MESSAGE_FROM_GS_GREATER_72HRS / fsm_power_down_comms
ST_LP_WAITING_FOR_GS_MESSAGE --> ST_RECOVERY : EV_SYS_START
ST_LP_WAITING_FOR_GS_MESSAGE --> ST_LP_WAITING_FOR_GS_MESSAGE : EV_ANY

ST_LP_CONNECTED_TO_GS --> ST_CP_POWER_DOWN_COMMS : <<critical>> EV_EPS_VOLTAGE_CRITICAL / fsm_power_down_comms
ST_LP_CONNECTED_TO_GS --> ST_SP_DISABLE_BEACONING_ATTEMPT1 : <<safe>> EV_EPS_VOLTAGE_SAFE / fsm_beaconing_disable
ST_LP_CONNECTED_TO_GS --> ST_CXN_CONNECTED_TO_GS : <<normal>> EV_EPS_VOLTAGE_NORMAL
ST_LP_CONNECTED_TO_GS --> ST_LP_WAITING_FOR_GS_MESSAGE : <<disconnected>> EV_GS_DISCONNECTED
ST_LP_CONNECTED_TO_GS --> ST_LP_CONNECTED_TO_GS : <<connected>> EV_GS_CONNECTED / fsm_restart_gs_connection_timer
ST_LP_CONNECTED_TO_GS --> ST_RECOVERY : EV_SYS_START
ST_LP_CONNECTED_TO_GS --> ST_LP_CONNECTED_TO_GS : EV_ANY

@enduml
